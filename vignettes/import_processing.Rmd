---
title: "Import & Processing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Import & Processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(ggplot2)
```

Different measuring devices and analysis software lead to opaque results in
measuring gas exchange parameters. To make exercise science more transparent and
reproducible, the `spiro` package offers a standardised workflow for data from
metabolic carts.

This vignette provides you information on the how the gas exchange data is
imported and processed by the package functions.

## One step import and processing with `spiro()`

To directly get started, paste the name of a breath-by-breath raw data file
produced by a supported metabolic cart device into the `spiro()` function. This
will return a `data.frame` containing all relevant data for each second of
testing, ready for summarising or plotting.

```{r setup}
library(spiro)

# Get example data
file <- spiro_example("zan_gxt")

spiro(file,
      device = NULL,
      weight = NULL,
      hr_file = NULL,
      hr_offset = 0,
      protocol = NULL)

```

`spiro()` will return interpolated data for the following parameters:

* **load**: velocity or power either retrieved from the raw data file or manually supplied by setting a protocol
* **step**: coded variable for the number of the step in the test protocol
* **time**: testing time (s)
* **VO2**: oxygen uptake (l/min)
* **VCO2**: carbon dioxide output (l/min)
* **RR**: respiratory rate (1/min)
* **VT**: tidal volume (l)
* **VE**: minute ventilation (l/min)
* **HR**: heart rate (1/min), if available
* **VO2_rel**: relative oxygen uptake (ml/min/kg)
* **VCO2_rel**: relative carbon dioxide output (ml/min/kg)
* **RER**: respiratory quotient
* **RE**: running economy (ml/kg/km), if applicable
* **CHO**: rate of carbohydrate oxidation (g/min)
* **FO**: rate of fat oxidation (g/min)

## `spiro()` under the hood

To create `data.frame`s as seen above, `spiro()` wraps multiple function, which
can be useful for providing additional options for the importing and processing
of the data.

```{r data flow, echo=FALSE}
ar <- arrow(length = unit(0.1, "inches"), type = "closed")
dsblue <- "#0053A4"

ggplot() +
  geom_rect(aes(xmin = 0.2, xmax = 0.8, ymin = 0.27, ymax = 0.84), colour = dsblue, fill = dsblue, alpha = 0.1, size = 1) +
  annotate("text", x = 0.21, y = 0.81, label = "spiro()", colour = dsblue, hjust = "left") +
  annotate(geom = "label", x = 0.5, y = 0.9, label = "data file", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.7, label = "raw data", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.55, label = "interpolated data", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.2, label = "spiro data.frame", label.padding = unit(0.5, "lines")) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.85, yend = 0.75), arrow = ar) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.65, yend = 0.6), arrow = ar) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.5, yend = 0.25), arrow = ar) +
  annotate("text", x = 0.53, y = 0.81, label = "spiro_import()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.63, label = "spiro_interpolate()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.46, label = "apply_protocol()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.38, label = "spiro_add()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.30, label = "hr_apply()", colour = "grey", hjust = "left") +
  geom_path(aes(x = c(0.57,0.75,0.75,0.7), y = c(0.7,0.7,0.46,0.46)), arrow = ar, linetype = 5) +
  geom_segment(aes(x = 0.85, xend = 0.7, y = 0.46, yend = 0.46), arrow = ar, linetype = 5) +
  annotate(geom = "label", x = 0.9, y = 0.46, label = "test protocol", label.padding = unit(0.5, "lines"), color = "grey") +
    geom_segment(aes(x = 0.85, xend = 0.65, y = 0.3, yend = 0.3), arrow = ar, linetype = 5) +
  annotate(geom = "label", x = 0.9, y = 0.3, label = "heart rate \n data file", label.padding = unit(0.5, "lines"), color = "grey") +
  scale_x_continuous(limits = c(0,1), expand = expansion(0,0), breaks = NULL) +
  scale_y_continuous(limits = c(0,1), expand = expansion(0,0), breaks = NULL) +
  labs(x = NULL, y = NULL) +
  theme_minimal()
```


### Import the data

`spiro_import()` imports the raw data from a raw spiroergometric file.
```{r import}
data_imp <- spiro_import(file,
                         device = NULL)
data_imp
```

#### Currently supported metabolic carts

The metabolic cart the file is produced by will be automatically guessed, but can also be set manually. Currently the following devices are supported:

* **CORTEX** (`"cortex"`): .xlsx or .xls files in German language
* **COSMED** (`"cosmed"`): .xlsx or .xls files in English or German language
* **ZAN** (`"zan"`): .dat files, usually with the name "EXED*" in German language

It is highly recommended to import only raw breath-by-breath data to avoid duplication of interpolation processes.

### Interpolate the data

`spiro_interpolate()` performs a linear interpolation on the imported data to obtain values for every second.
```{r interpolate}
data_int <- spiro_interpolate(data_imp)
data_int
```

Note that the linear interpolation will lead to a minor smoothing of the data.

### Guess or specify an exercise protocol

To archive the full functionality of data summary and plotting with the
spiro-package, a testing protocol needs to be attached to the imported data. The
parameters of exercise protocols in `spiro` are the following:

```{r protocol variable, echo=FALSE}
ar2 <- arrow(length = unit(0.1, "inches"), type = "closed", ends = "both")
path <- data.frame(x = c(0,0.1,0.1,0.3,0.3,0.32,0.32,0.42,0.42,0.44,0.44,0.54,0.54,0.56,0.56,0.66,0.66,0.68,0.68,0.78,0.78,0.8,0.8,0.9,0.9,0.95),
                   y = c(0,0,0.2,0.2,0,0,0.4,0.4,0,0,0.5,0.5,0,0,0.6,0.6,0,0,0.7,0.7,0,0,0.8,0.8,0,0))
ggplot() +
  geom_segment(aes(x = 0, xend = 0.95, y = 0, yend = 0),colour = "grey", size = 1) +
  geom_path(aes(x = x, y = y), data = path, size = 1, colour = dsblue) +
  geom_segment(aes(x = 0, xend = 0.1, y = -0.05, yend = -0.05), arrow = ar2, size = 1) +
  annotate("text", x = 0.05, y = -0.1, label = "pre.duration") +
  geom_segment(aes(x = 0.1, xend = 0.3, y = -0.05, yend = -0.05), arrow = ar2, size = 1) +
  annotate("text", x = 0.2, y = -0.1, label = "wu.duration") +
  geom_segment(aes(x = 0.56, xend = 0.66, y = -0.05, yend = -0.05), arrow = ar2, size = 1) +
  annotate("text", x = 0.61, y = -0.1, label = "step.duration") +
  geom_segment(aes(x = 0.78, xend = 0.8, y = -0.05, yend = -0.05), size = 2) +
  annotate("text", x = 0.79, y = -0.1, label = "rest.duration") +
  geom_segment(aes(x = 0.12, xend = 0.12, y = 0, yend = 0.2), arrow = ar2, size = 1) +
  annotate("text", x = 0.14, y = 0.1, label = "wu.load", hjust = "left") +
  geom_segment(aes(x = 0.34, xend = 0.34, y = 0, yend = 0.4), arrow = ar2, size = 1) +
  annotate("text", x = 0.31, y = 0.3, label = "step.start", hjust = "right") +
  geom_segment(aes(x = 0.66, xend = 0.66, y = 0.6, yend = 0.7), arrow = ar2, size = 1) +
  annotate("text", x = 0.64, y = 0.65, label = "step.increment", hjust = "right") +
  annotate("text", x = 0.85, y = 0.75, label = "5", colour = "black") +
  annotate("text", x = 0.85, y = 0.85, label = "step.count",) +
  geom_segment(aes(x = 0.34, xend = 0.31, y = -0.05, yend = -0.01), size = 1) +
  annotate("text", x = 0.35, y = -0.05, label = "rest.initial?", hjust = "left") +
  scale_x_continuous(limits = c(-0.02,1), expand = expansion(0,0), breaks = NULL) +
  scale_y_continuous(limits = c(-0.15,1), expand = expansion(0,0), breaks = NULL) +
  labs(x = "time", y = "load") +
  theme_minimal()
```


#### Guessing a protocol

By default, `spiro()` tries to guess the testing protocol using `guess_protocol()`, looking for velocity or load data in the imported, but not interpolated raw data.

```{r guess_protocol}
guess_protocol(data_imp)

```

#### Manually supplying a protocol

In cases where there is no load data saved in the metabolic cart's file, or `guess_protocol()` turns wrong, a protocol can be manually generated via `spiro_protocol()` and applied to the interpolated data by `apply_protocol()`.

```{r spiro_protocol}
ptcl <- spiro_protocol(step.start = 150, 
          step.increment = 30, 
          step.duration = 180,
          rest.duration = 0, 
          pre.duration = 60, 
          wu.duration = 0,
          wu.load = 0, 
          step.count = 7, 
          rest.initial = FALSE)

data_with_ptcl <- apply_protocol(data_int, ptcl)
```

To avoid specifying every single protocol parameter to `spiro_protocol()` there are wrapper function for common types of exercise test:

* `spiro_protocol_gxt`
  : for graded exercise/ incremental step test. Deletes any warm-up and sets rest duration to 30s.
* `spiro_protocol_rmp`
  : for ramp tests. Creates a two-minute warm up directly leading into incremental 30s-steps without rest in between.
* `spiro_protocol_clt`
  : for constant load test. Creates six steps of five minute load with 30s rest in between, following a five minute warm up with half the load.

### Calculate additional parameters from the data

The interpolated gas exchange data, together with the protocol load data, allows the calculation of additional variables with `spiro_add()`.

```{r spiro_add}
spiro_add(data_with_ptcl,
          weight = NULL)

```

For calculating parameters relative to body weight, `spiro_add()` will use the weight found in the original data file's meta data. If for some reason no or the wrong weight was present in the raw data file, `weight` can be manually supplied.

### Attach additional heart rate data

Some metabolic carts only offer complicated options for connecting them to heart rate monitors. If heart rate data was recorded by another kind of device (e.g. wrist watch), this data can be attached to the existing `data.frame` of gas exchange measures with `hr_add()`.

```{r hr_add}
#hr_add(data_with_ptcl,
#       hr_file = NULL,
#       hr_offset = 0)
```

`hr_add()` will import the heart rate data from a .tcx file via `hr_import()` and attach it to the existing data with `hr_apply()`. Note that you can manually supply the starting point of the heart rate recording in relation to the gas exchange measures recording with `hr_offset`.
