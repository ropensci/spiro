---
title: "Import & Processing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Import & Processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)

library(ggplot2)
ar <- arrow(length = unit(0.1, "inches"), type = "closed")
dsblue <- "#0053A4"
```

Different measuring devices and analysis software lead to opaque results in
measuring gas exchange parameters. To make exercise science more transparent and
reproducible, the `spiro` package offers a standardized workflow for data from
metabolic carts.

This vignette provides you information on how the the `spiro` package imports and processes data from cardiopulmonary exercise testing.

## Import and processing with `spiro()`

To import and process data is quite easy: The `spiro()` function does all the work for you. You just need to paste the path of a file with raw data from cardiopulmonary exercise testing to the function. This will return a `data.frame` containing all relevant data for each second of testing, ready for summarising or plotting.

```{r setup}
library(spiro)

# Get example data
file <- spiro_example("zan_gxt")

spiro(file)

```

`spiro()` will return interpolated data for the following parameters:

* **load**: velocity or power, either retrieved from the raw data file or manually supplied by setting a protocol
* **step**: coded variable for the number of the load step in the test protocol
* **time**: time (s)
* **VO2**: oxygen uptake (ml/min)
* **VCO2**: carbon dioxide output (ml/min)
* **RR**: respiratory rate (1/min)
* **VT**: tidal volume (l)
* **VE**: minute ventilation (l/min)
* **HR**: heart rate (bpm), if available
* **PetO2**: end-tidal partial pressure of oxygen (mmHg)
* **PetCO2**: end-tidal partial pressure of carbon dioxide (mmHg)
* **VO2_rel**: relative oxygen uptake (ml/min/kg)
* **VCO2_rel**: relative carbon dioxide output (ml/min/kg)
* **RE**: running economy (ml/kg/km), if applicable
* **RER**: respiratory quotient
* **CHO**: rate of carbohydrate oxidation (g/min)
* **FO**: rate of fat oxidation (g/min)

You can control the exercise protocol, the calculation of parameters related to body weight and the adding of heart rate data with the arguments in `spiro` or with the helper functions `add_*` within a piping syntax.

## Supported metabolic carts

The `spiro` package supports different metabolic carts. The metabolic cart a data file is produced by is usually determined automatically, but can also be set manually in the `spiro()` function. Currently this package supports the following devices:

* **CORTEX** (`"cortex"`): .xlsx or .xls files in German language
* **COSMED** (`"cosmed"`): .xlsx or .xls files in English or German language
* **ZAN** (`"zan"`): .dat files, usually with the name "EXED*" in German language

It is highly recommended to import only raw breath-by-breath data to work with all available data and avoid the duplication of interpolation processes.

To only import the data without further processing (such as interpolation) use the function `spiro_import()`:

```{r import}
spiro_import(file, device = NULL)
```

Alternatively you can access the raw data after a `spiro()` call by extracting the `raw` attribute of the result.

```{r attr, eval=FALSE}
s <- spiro(file)
attr(s,"raw")
```


## Exercise protocols

To achieve the full functionality of further data summary and plotting with the
`spiro` package, a testing protocol needs to be attached to the data. 

### Protocol guessing

By default, `spiro()` guesses the exercise protocol using `get_protocol()`,
looking for velocity or load data in the imported raw data. To return the
protocol guess after a `spiro()` call, access the `protocol` attribute.

```{r protocol}
s <- spiro(file)
attr(s,"protocol")
```

### Protocol setting

In cases where there is no load data saved in the metabolic cart's file, or
`get_protocol()` turns wrong, a protocol can be manually generated.

There are two ways to initially generate a protocol: completely manual with
`set_protocol_manual()` or using a helper function `set_protocol()`. Once a
protocol has been set, it can be used as the `protocol` argument in a `spiro()` call or attached to a `spiro` data frame with `add_protocol()`.

```{r set_protocol_manual}
# manually setting a test protocol
pt <- set_protocol_manual(
  duration = c(60,300,30,300,30,300,30,300,30,300,30,300,30,300,30,300,30,300),
  load = c(0,3,0,3.2,0,3.4,0,3.6,0,3.8,0,4,0,4.2,0,4.4,0,4.6)
)

# attach protocol within spiro call
s <- spiro(file, protocol = pt)

# attach protocol with `add_protocol`
t <- spiro(file)
add_protocol(t, pt)
```

With `set_protocol` a protocol can be defined without specifying every single load step. You can paste the pre-defined segment types `pre()`, `wu()`, `const()`and `steps()` into `set_protocol()` in the desired order. The following graph illustrates an example of this practice:

```{r protocol variable, echo=FALSE}
ar2 <- arrow(length = unit(0.1, "inches"), type = "closed", ends = "both")
path <- data.frame(
  x = c(0,0.1,0.1,0.3,0.3,0.32,0.32,0.42,0.42,0.44,0.44,0.54,0.54,0.56,0.56,0.66,0.66,0.68,0.68,0.78,0.78,0.8,0.8,0.9,0.9,0.95),
  y = c(0,0,0.2,0.2,0,0,0.4,0.4,0,0,0.5,0.5,0,0,0.6,0.6,0,0,0.7,0.7,0,0,0.8,0.8,0,0),
  type = factor(
    c("pre","wu","wu","wu","wu",rep("load",21)),
    levels = c("pre","wu","load")
  )
)
ggplot() +
  geom_segment(aes(x = 0, xend = 0.95, y = 0, yend = 0),colour = "grey", size = 1) +
  geom_path(aes(x = x, y = y, colour = type), data = path, size = 1, group = TRUE, show.legend = FALSE) +
  annotate("text", x = c(0.03,0.05,0.05,0.05,0.03), y = c(0.97,0.90,0.83,0.76,0.69), 
           label = c(
             "set_protocol(",
             "pre(duration),",
             "wu(duration, load, rest),",
             "steps(duration, load, increment, count, rest)",
              ")"), 
           hjust = "left", vjust = "top",
           colour = c("black", "#d55e00", "#009e73", dsblue, "black"),
           size = 4.5) +
  scale_x_continuous(limits = c(-0.02,1), expand = expansion(0,0), breaks = NULL) +
  scale_y_continuous(limits = c(-0.15,1), expand = expansion(0,0), breaks = NULL) +
  scale_colour_manual(values = c("#d55e00","#009e73",dsblue)) +
  labs(x = "time", y = "load") +
  theme_minimal()
```

```{r}
set_protocol(pre(60), wu(300,80), steps(180,100,25,6,30))
```

## Modify body weight

The `spiro` package calculates parameters relative to body weight. Per default `spiro` will look for information on body weight in the meta data of the original data file. If for some reason no or the wrong weight was present in the raw data file, `weight` can be manually supplied as an argument in `spiro()` or with `add_weight`.

```{r}
# set body weight as an argument in `spiro()`
s <- spiro(file, weight = 68.3)

# set body weight using `add_weight()`
t <- spiro(file) |>
  add_weight(68.3)

```

## Work with external heart rate data

Some metabolic carts only offer complicated options for connecting them to heart rate monitors. If heart rate data was recorded by another kind of device (e.g. wrist watch), this data can be added within the `spiro()` call or using `add_hr()`.

```{r hr_add}
# get example data file path
hpath <- spiro_example("hr_ramp.tcx")

# add heart rate data within `spiro()`
h <- spiro(file, hr_file = hpath, hr_offset = 0)

# add heart rate data with `add_hr()`
i <- spiro(file) |>
  add_hr(hr_file = hpath, hr_offset = 0)
```

`add_hr()` will import the heart rate data from a .tcx file and attach it to the existing data set. You can manually set the starting point of the heart rate recording relative to the start of the gas exchange measures recording with the `hr_offset` argument.
