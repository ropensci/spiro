---
title: "Import & Processing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Import & Processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300
)

library(ggplot2)
ar <- arrow(length = unit(0.1, "inches"), type = "closed")
dsblue <- "#0053A4"
```

Different measuring devices and analysis software lead to opaque results in
measuring gas exchange parameters. To make exercise science more transparent and
reproducible, the `spiro` package offers a standardised workflow for data from
metabolic carts.

This vignette provides you information on the how the gas exchange data is
imported and processed by the package functions.

## One step import and processing with `spiro()`

To directly get started, paste the name of a breath-by-breath raw data file
produced by a supported metabolic cart device into the `spiro()` function. This
will return a `data.frame` containing all relevant data for each second of
testing, ready for summarising or plotting.

```{r setup}
library(spiro)

# Get example data
file <- spiro_example("zan_gxt")

spiro(file,
      device = NULL,
      weight = NULL,
      hr_file = NULL,
      hr_offset = 0,
      protocol = NULL)

```

`spiro()` will return interpolated data for the following parameters:

* **load**: velocity or power either retrieved from the raw data file or manually supplied by setting a protocol
* **step**: coded variable for the number of the step in the test protocol
* **time**: testing time (s)
* **VO2**: oxygen uptake (l/min)
* **VCO2**: carbon dioxide output (l/min)
* **RR**: respiratory rate (1/min)
* **VT**: tidal volume (l)
* **VE**: minute ventilation (l/min)
* **HR**: heart rate (1/min), if available
* **VO2_rel**: relative oxygen uptake (ml/min/kg)
* **VCO2_rel**: relative carbon dioxide output (ml/min/kg)
* **RER**: respiratory quotient
* **RE**: running economy (ml/kg/km), if applicable
* **CHO**: rate of carbohydrate oxidation (g/min)
* **FO**: rate of fat oxidation (g/min)

## `spiro()` under the hood

To create `data.frame`s as seen above, `spiro()` wraps multiple function, which
can be useful for providing additional options for the importing and processing
of the data.

```{r data flow, echo=FALSE}

ggplot() +
  geom_rect(aes(xmin = 0.2, xmax = 0.8, ymin = 0.27, ymax = 0.84), colour = dsblue, fill = dsblue, alpha = 0.1, size = 1) +
  annotate("text", x = 0.21, y = 0.81, label = "spiro()", colour = dsblue, hjust = "left") +
  annotate(geom = "label", x = 0.5, y = 0.9, label = "data file", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.7, label = "raw data", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.55, label = "interpolated data", label.padding = unit(0.5, "lines")) +
  annotate(geom = "label", x = 0.5, y = 0.2, label = "spiro data.frame", label.padding = unit(0.5, "lines")) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.85, yend = 0.75), arrow = ar) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.65, yend = 0.6), arrow = ar) +
  geom_segment(aes(x = 0.5, xend = 0.5, y = 0.5, yend = 0.25), arrow = ar) +
  annotate("text", x = 0.53, y = 0.81, label = "spiro_import()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.63, label = "spiro_interpolate()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.46, label = "apply_protocol()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.38, label = "spiro_add()", colour = "grey", hjust = "left") +
  annotate("text", x = 0.53, y = 0.30, label = "hr_apply()", colour = "grey", hjust = "left") +
  geom_path(aes(x = c(0.57,0.75,0.75,0.7), y = c(0.7,0.7,0.46,0.46)), arrow = ar, linetype = 5) +
  geom_segment(aes(x = 0.85, xend = 0.7, y = 0.46, yend = 0.46), arrow = ar, linetype = 5) +
  annotate(geom = "label", x = 0.9, y = 0.46, label = "test protocol", label.padding = unit(0.5, "lines"), color = "grey") +
    geom_segment(aes(x = 0.85, xend = 0.65, y = 0.3, yend = 0.3), arrow = ar, linetype = 5) +
  annotate(geom = "label", x = 0.9, y = 0.3, label = "heart rate \n data file", label.padding = unit(0.5, "lines"), color = "grey") +
  scale_x_continuous(limits = c(0,1), expand = expansion(0,0), breaks = NULL) +
  scale_y_continuous(limits = c(0,1), expand = expansion(0,0), breaks = NULL) +
  labs(x = NULL, y = NULL) +
  theme_minimal()
```


### Import the data

`spiro_import()` imports the raw data from a raw spiroergometric file.
```{r import}
data_imp <- spiro_import(file, device = NULL)
data_imp
```

#### Currently supported metabolic carts

The metabolic cart the file is produced by will be automatically guessed, but can also be set manually. Currently the following devices are supported:

* **CORTEX** (`"cortex"`): .xlsx or .xls files in German language
* **COSMED** (`"cosmed"`): .xlsx or .xls files in English or German language
* **ZAN** (`"zan"`): .dat files, usually with the name "EXED*" in German language

It is highly recommended to import only raw breath-by-breath data to avoid duplication of interpolation processes.

### Interpolate the data

`spiro_interpolate()` performs a linear interpolation on the imported data to obtain values for every second.
```{r interpolate}
data_int <- spiro_interpolate(data_imp)
data_int
```

Note that the linear interpolation will lead to a minor smoothing of the data.

### Guess or specify an exercise protocol

To achieve the full functionality of later data summary and plotting with the
spiro-package, a testing protocol needs to be attached to the imported data. 

#### Guessing a protocol

By default, `spiro()` tries to guess the testing protocol using
`guess_protocol()`, looking for velocity or load data in the imported, but not
interpolated raw data.

```{r guess_protocol}
get_protocol(data_imp)

```

#### Manually supplying a protocol

In cases where there is no load data saved in the metabolic cart's file, or
`get_protocol()` turns wrong, a protocol can be manually generated. There are to
ways to initially generate a protocol, either completely manual with
`set_protocol_manual()` or using a helper function `set_protocol()`. Once a
protocol has been set, it can be attached to an existing data.frame with
`process_protocol()` and `apply_protocol()`.

```{r set_protocol_manual}
# manually setting a test protocol
pt <- set_protocol_manual(
  duration = c(60,300,30,300,30,300,30,300,30,300,30,300,30,300,30,300,30,300),
  load = c(0,3,0,3.2,0,3.4,0,3.6,0,3.8,0,4,0,4.2,0,4.4,0,4.6)
)

# apply protocol to data.frame
data_with_ptcl <- apply_protocol(data = data_int, 
                                 protocol = process_protocol(pt))
data_with_ptcl
```

Alternatively to providing every single load step, a protocol can be defined by
segments with `set_protocol`. Pre-defined segment types such as `pre()`, `wu()`
and `steps()` can be pasted into the function in the desired order. The
following graph illustrates an example:

```{r protocol variable, echo=FALSE}
ar2 <- arrow(length = unit(0.1, "inches"), type = "closed", ends = "both")
path <- data.frame(
  x = c(0,0.1,0.1,0.3,0.3,0.32,0.32,0.42,0.42,0.44,0.44,0.54,0.54,0.56,0.56,0.66,0.66,0.68,0.68,0.78,0.78,0.8,0.8,0.9,0.9,0.95),
  y = c(0,0,0.2,0.2,0,0,0.4,0.4,0,0,0.5,0.5,0,0,0.6,0.6,0,0,0.7,0.7,0,0,0.8,0.8,0,0),
  type = factor(
    c("pre","wu","wu","wu","wu",rep("load",21)),
    levels = c("pre","wu","load")
  )
)
ggplot() +
  geom_segment(aes(x = 0, xend = 0.95, y = 0, yend = 0),colour = "grey", size = 1) +
  geom_path(aes(x = x, y = y, colour = type), data = path, size = 1, group = TRUE, show.legend = FALSE) +
  annotate("text", x = c(0.03,0.05,0.05,0.05,0.03), y = c(0.97,0.90,0.83,0.76,0.69), 
           label = c(
             "set_protocol(",
             "pre(duration),",
             "wu(duration, load, rest),",
             "steps(duration, load, increment, count, rest)",
              ")"), 
           hjust = "left", vjust = "top",
           colour = c("black", "#d55e00", "#009e73", dsblue, "black"),
           size = 4.5) +
  scale_x_continuous(limits = c(-0.02,1), expand = expansion(0,0), breaks = NULL) +
  scale_y_continuous(limits = c(-0.15,1), expand = expansion(0,0), breaks = NULL) +
  scale_colour_manual(values = c("#d55e00","#009e73",dsblue)) +
  labs(x = "time", y = "load") +
  theme_minimal()
```

```{r}
set_protocol(pre(60), wu(300,80), steps(180,100,25,6,30))
```

### Calculate additional parameters from the data

The interpolated gas exchange data, together with the protocol load data, allows
the calculation of additional variables with `spiro_add()`.

```{r spiro_add}
spiro_add(data_with_ptcl,
          weight = NULL)

```

For calculating parameters relative to body weight, `spiro_add()` will use the
weight found in the original data file's meta data. If for some reason no or the
wrong weight was present in the raw data file, `weight` can be manually
supplied.

### Attach additional heart rate data

Some metabolic carts only offer complicated options for connecting them to heart rate monitors. If heart rate data was recorded by another kind of device (e.g. wrist watch), this data can be attached to the existing `data.frame` of gas exchange measures with `hr_add()`.

```{r hr_add}
# import and process example data
data_rt <- spiro(spiro_example("zan_ramp"))
hr_data <- spiro_example("hr_ramp.tcx")

hr_add(data_rt,
       hr_file = hr_data,
       hr_offset = 0)
```

`hr_add()` will import the heart rate data from a .tcx file via `hr_import()` and attach it to the existing data with `hr_apply()`. Note that you can manually supply the starting point of the heart rate recording in relation to the gas exchange measures recording with `hr_offset`.
