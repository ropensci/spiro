#' Plot data from spiroergometry files
#'
#' \code{spiro_plot_*()} returns a \code{ggplot2} graph visualising
#' data from a spiroergometric test.
#'
#' This function provides a shortcut for visualising spiroergometric data from
#' \code{\link{spiro}} with \code{ggplot2}. It generates a graph showing the
#' (smoothed) interpolated data, as well as the underlying test protocol.
#'
#' @param data A \code{data.frame} of the class \code{spiro_*}, as it is
#'   generated by \code{\link{spiro}}.
#' @param smooth Integer for calculation of a rolling average (in seconds)
#'   for gas exchange measures.
#'
#' @examples
#' # Import and process example data
#' ramp_data <- spiro(file = spiro_example("zan_ramp"),
#'                   hr_file = spiro_example("hr_ramp.tcx"))
#'
#' spiro_plot_VO2(ramp_data)
#'
#' spiro_plot_HR(ramp_data)
#'
#' @name spiro_plot
NULL


spiro_plot.VE <- function(data, smooth = 15) {

  data$VE <- zoo::rollmean(data$VE, smooth, na.pad = TRUE)

  ggplot2::ggplot(data = data, ggplot2::aes(x = time)) +
    list(
      if (!requireNamespace("ggborderline",quietly = TRUE)) {
        ggplot2::geom_line(
          ggplot2::aes(y = VE, colour = "VE (l/min)"),
          size = 1, na.rm = TRUE)
      } else {
        ggborderline::geom_borderline(
          ggplot2::aes(y = VE, colour = "VE (l/min)"),
          size = 1, na.rm = TRUE)
      }
    ) +
    ggplot2::scale_colour_manual(values = "#003300") +
    ggplot2::labs(x = "Duration (s)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}


#' @rdname spiro_plot
#' @export
spiro_plot_VO2 <- function(data, smooth = 15) {

  yl <- spiro_plot.guess_units(data)

  # create data frame with rolling averages
  d <- data.frame(
    time = data$time,
    load = data$load,
    VO2_rel = zoo::rollmean(data$VO2_rel, smooth, na.pad = TRUE),
    VCO2_rel = zoo::rollmean(data$VCO2_rel, smooth, na.pad = TRUE)
  )

  # reshape data into long format
  d_long <- reshape(d, direction = "long",varying = c("VO2_rel","VCO2_rel"),v.names = "value", idvar = c("time","load"), times = c("VO2_rel","VCO2_rel"), timevar = "measure")
  d_long$measure <- factor(d_long$measure, levels = c("VO2_rel","VCO2_rel"), labels = c("VO2_rel (ml/min/kg)","VCO2_rel (ml/min/kg)"))

  ggplot2::ggplot(data = d_long, ggplot2::aes(x = time)) +
    ggplot2::geom_area(
      ggplot2::aes(y = load * yl[[1]]),
      colour = "black", alpha = 0.5, position = "identity") +
    list(
      if (!requireNamespace("ggborderline",quietly = TRUE)) {
        ggplot2::geom_line(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      } else {
        ggborderline::geom_borderline(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      }
    ) +
    ggplot2::scale_y_continuous(
      sec.axis = ggplot2::sec_axis( ~. / yl[[1]],
                                    name = yl[[2]])) +
    ggplot2::scale_color_manual(values = c("#c00000","#0053a4")) +
    ggplot2::labs(x = "Duration (s)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}

spiro_plot.EQ_CO2 <- function(data) {
  raw <- attr(data,"raw")
  # bring VCO2 data into desired unit (l/min)
  raw$VCO2 <- raw$VCO2 / 1000

  ggplot2::ggplot(data = raw, ggplot2::aes(x = VCO2, y = VE)) +
    ggplot2::geom_point(size = 2.5, shape = 21, fill = "#0053a4", colour = "white", na.rm = TRUE) +
    ggplot2::labs(x = "VCO2 (l/min)", y = "VE (l/min)") +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank())
}

#' @rdname spiro_plot
#' @export

spiro_plot_HR <- function(data) {

  sec_axis_factor <- 5
  data$pulse <- zoo::rollmean(data$VO2 / data$HR, smooth, na.pad = TRUE) * sec_axis_factor
  data$HR <- zoo::rollmean(data$HR, smooth, na.pad = TRUE)

  d <- data[,c("time","load","pulse","HR")]
  d_long <- reshape(d, direction = "long",varying = c("pulse","HR"),v.names = "value", idvar = c("time","load"), times = c("pulse","HR"), timevar = "measure")
  d_long$measure <- factor(d_long$measure, levels = c("HR","pulse"), labels = c("HR (bpm)","VO2/HR (ml)"))

  ggplot2::ggplot(data = d_long, ggplot2::aes(x = time)) +
    list(
      if (!requireNamespace("ggborderline",quietly = TRUE)) {
        ggplot2::geom_line(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      } else {
        ggborderline::geom_borderline(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      }
    ) +
    ggplot2::scale_colour_manual(values = c("red","pink")) +
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis( ~. / sec_axis_factor)) +
    ggplot2::labs(x = "Duration (s)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}

spiro_plot.Vslope <- function(data) {
  raw <- attr(data,"raw")
  # remove rows without time stamp
  raw <- raw[!is.na(raw$time),]

  # match HR to breath-by-breath raw data if no raw heartrate data is available
  if (!(raw$HR != 0 && !is.na(raw$HR))) {
    raw$HR <- data$HR[replace(round(raw$time),round(raw$time) == 0, 1)]
  }
  # bring VO2 data into desired unit (l/min)
  raw$VO2 <- raw$VO2 / 1000
  # scale VCO2 data for being displayed on second y-axis
  raw$VCO2 <- raw$VCO2 /20
  raw <- raw[,c("time","HR","VO2","VCO2")]

  raw_long <- reshape(raw, direction = "long",varying = c("HR","VCO2"),v.names = "value", idvar = c("time"), times = c("HR","VCO2"), timevar = "measure")
  raw_long$measure <- factor(raw_long$measure, levels = c("HR","VCO2"), labels = c("HR (bpm)","VCO2 (l/min)"))

  ggplot2::ggplot(data = raw_long, ggplot2::aes(x = VO2, y = value, fill = measure)) +
    ggplot2::geom_point(size = 2.5, na.rm = TRUE, shape = 21, colour = "white") +
    ggplot2::scale_fill_manual(values = c("red","#0053a4")) +
    ggplot2::scale_y_continuous(sec.axis = ggplot2::sec_axis( ~. / 50)) +
    ggplot2::labs(x = "VO2 (l/min)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}

spiro_plot.EQ <- function(data, smooth = 15) {

  # remove implausible high values before smoothing
  data$EQ_O2 <- 1000 * data$VE / data$VO2
  data$EQ_O2[which(data$EQ_O2 > 100)] <- NA
  data$EQ_O2 <- zoo::rollmean(data$EQ_O2, smooth, na.pad = TRUE)

  data$EQ_CO2 <- 1000 * data$VE / data$VCO2
  data$EQ_CO2[which(data$EQ_CO2 > 100)] <- NA
  data$EQ_CO2 <- zoo::rollmean(data$EQ_CO2, smooth, na.pad = TRUE)

  d <- data[,c("time","load","EQ_O2","EQ_CO2")]
  d_long <- reshape(d, direction = "long",varying = c("EQ_O2","EQ_CO2"),v.names = "value", idvar = c("time","load"), times = c("EQ_O2","EQ_CO2"), timevar = "measure")
  d_long$measure <- factor(d_long$measure, levels = c("EQ_O2","EQ_CO2"))

  ggplot2::ggplot(data = d_long, ggplot2::aes(x = time)) +
    list(
      if (!requireNamespace("ggborderline",quietly = TRUE)) {
        ggplot2::geom_line(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      } else {
        ggborderline::geom_borderline(
          ggplot2::aes(y = value, colour = measure),
          size = 1, na.rm = TRUE)
      }
    ) +
    ggplot2::scale_colour_manual(values = c("#c00000","#0053a4")) +
    ggplot2::labs(x = "Duration (s)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}

spiro.plot_Ventilation <- function(data) {
  raw <- attr(data,"raw")

  ggplot2::ggplot(data = raw, ggplot2::aes(x = VE, y = VT)) +
    ggplot2::geom_point(size = 2.5, shape = 21, fill = "grey30", colour = "white", na.rm = TRUE) +
    ggplot2::labs(x = "VE (l/min)", y = "VT (l)") +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank())
}

spiro_plot.RER <- function(data, smooth = 15) {
  data$RER <- zoo::rollmean(data$RER, smooth, na.pad = TRUE)

  ggplot2::ggplot(data = data, ggplot2::aes(x = time)) +
    list(
      if (!requireNamespace("ggborderline",quietly = TRUE)) {
        ggplot2::geom_line(
          ggplot2::aes(y = RER, colour = "RER"),
          size = 1, na.rm = TRUE)
      } else {
        ggborderline::geom_borderline(
          ggplot2::aes(y = RER, colour = "RER"),
          size = 1, na.rm = TRUE)
      }
    ) +
    ggplot2::scale_colour_manual(values = "#003300") +
    ggplot2::labs(x = "Duration (s)", y = NULL) +
    ggplot2::theme_minimal(13) +
    ggplot2::theme(panel.grid.minor.x = ggplot2::element_blank(),
                   legend.position = c(0.15,0.9),
                   legend.background = ggplot2::element_rect(colour = "white",fill = alpha('white',0.9)),
                   legend.title = ggplot2::element_blank())
}

#' Adjust axes in spiroergometric data plot
#'
#' Internal function to \code{?link{spiro_plot}}
#'
#' @param data A \code{data.frame} of the class \code{spiro_*}.
#' @noRd
spiro_plot.guess_units <- function(data) {
  ymax <- max(data$load, na.rm = TRUE)
  if (ymax <= 8) {
    yscale <- 5
    ylabel <- "Velocity (m/s)"
  } else if (ymax <= 30) {
    yscale <- 2
    ylabel <- "Velocity (km/h)"
  } else {
    yscale <- 0.1
    ylabel <- "Power (W)"
  }
  out <- list(yscale, ylabel)
  out
}
